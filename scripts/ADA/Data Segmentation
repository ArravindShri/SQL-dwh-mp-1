/* Group customer into three segments based on their spending behavior
VIP- Spending more than 5000 euros and 12 month history
Regular- Spending 5000 euros, less and 12 month history
New: customer with 12 month life span

Total customers in each group*/
WITH spending_query AS (
    SELECT 
        c.customer_key,
        SUM(f.sales_amount) AS total_spending,
        MIN(order_date) AS first_order,
        MAX(order_date) AS last_order,
        DATEDIFF(month, MIN(order_date), MAX(order_date)) AS life_span
    FROM gold.fact_sales AS f
    LEFT JOIN gold.dim_customer AS c
        ON f.customer_key = c.customer_key
    GROUP BY c.customer_key
),
customer_segments as (SELECT 
    customer_key,
    total_spending,
    life_span,
    CASE 
        WHEN life_span >= 12 AND total_spending > 5000 THEN 'VIP'
        WHEN life_span >= 12 AND total_spending <= 5000 THEN 'Regular'
        ELSE 'New'
    END AS customer_segment
FROM spending_query
)

SELECT
    customer_segment,
    COUNT(DISTINCT customer_key) AS total_customers
FROM customer_segments
GROUP BY customer_segment
ORDER BY total_customers DESC;
